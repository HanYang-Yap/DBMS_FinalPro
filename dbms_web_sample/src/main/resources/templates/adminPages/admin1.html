<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>dbmaG6_admin1</title>
    <!-- <link rel="stylesheet" href="./admin1.css" /> -->
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>
  </head>
  <!-- start of body -->
  <body>
    <!-- header is here -->
    <header>
      <!-- user_icon is here -->
      <div class="user_icon">
        <a href="../home&loginpage/index.html"
          ><img src="/Image/NCCU_logo.png" alt="adminÈ†≠Ë≤º"
        /></a>
        <h3>Hi</h3>
      </div>
      <div class="login_time">
        <!-- <p id="current_date"></p>Êé•‰∏äcurrent time -->
        <div id="current_date" style="font-weight: bold; font-size: smaller">
          <script>
            // Get the current date
            var currentDate = new Date().toLocaleString();

            // Concatenate "Login time:" with the date string
            var dateTimeString = "ÁôªÂÖ•ÊôÇÈñì " + currentDate;

            // Set the concatenated string as the inner HTML of the div
            document.getElementById("current_date").innerHTML = dateTimeString;
          </script>
        </div>
      </div>
    </header>
    <div class="main_sec">
      <div class="title">
        <h1>Posts</h1>
        <h3 class="add_btn"><a href="./admin2.html">+add Posts</a></h3>
        <h3 class="host_btn"><a href="./adminhost.html">host >></a></h3>
      </div>
      <table>
        <tr>
          <th>Pin</th>
          <th>Notification</th>
          <th>Location</th>
          <th>Date</th>
          <th>Edit</th>
        </tr>
        <tbody id="tableBody">
          <!-- Table rows will be inserted here by JavaScript -->
        </tbody>
      </table>
    </div>
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js";
      import {
        get,
        ref,
        child,
        getDatabase,
        remove,
      } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-database.js";

      const firebaseConfig = {
        apiKey: "AIzaSyANq5gccfu7i5d6JVNUE8Uw8YSKIvJUZko",
        authDomain: "db-github-11ca8.firebaseapp.com",
        databaseURL:
          "https://db-github-11ca8-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "db-github-11ca8",
        storageBucket: "db-github-11ca8.appspot.com",
        messagingSenderId: "236802727820",
        appId: "1:236802727820:web:27b36c651eb849c1ed40a9",
      };

      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);

      function findNoti() {
        console.log("page loaded!!");
        const tableBody = document.querySelector("#tableBody");
        tableBody.innerHTML = "";

        const dbref = ref(db);
        get(child(dbref, "notifications/"))
          .then((snapshot) => {
            if (snapshot.exists()) {
              const notifications = [];
              snapshot.forEach((childSnapshot) => {
                const notification = childSnapshot.val();
                notifications.push(notification);
              });

              notifications.sort((a, b) => {
                return a.Pin === b.Pin ? 0 : a.Pin ? -1 : 1;
              });

              notifications.forEach((notification) => {
                const newRow = document.createElement("tr");

                const pinCell = document.createElement("td");
                notification.Pin ? (pinCell.textContent = "üìå") : "";
                const notificationCell = document.createElement("td");
                notificationCell.textContent = notification.Context;
                const locationCell = document.createElement("td");
                locationCell.textContent = notification.Venue;
                const dateCell = document.createElement("td");
                dateCell.textContent = notification.Date;

                const editCell = document.createElement("td");
                const deleteButton = document.createElement("button");
                deleteButton.textContent = "DELETE";
                var currentDate = new Date().toLocaleString();
                deleteButton.setAttribute("id", "noti_id" + currentDate);

                // define deleteDoubleCheck function
                function deleteDoubleCheck(action) {
                  // console.log("confirm action activated");
                  var result = confirm("Are you sure to delete?");
                  if (result) {
                    alert("Â∑≤Á¢∫Ë™çÂü∑Ë°åÔºö" + action);
                    // Âú®ÈÄôË£°Âü∑Ë°åÁ¢∫Ë™çÂæåÁöÑÊìç‰Ωú
                  } else {
                    alert("Â∑≤ÂèñÊ∂àÊìç‰ΩúÔºö" + action);
                    // Âú®ÈÄôË£°Âü∑Ë°åÂèñÊ∂àÂæåÁöÑÊìç‰Ωú
                  }
                }
                deleteButton.addEventListener("click", () => {
                  // console.log("‰Ω†ÊåâÂà∞deletebutton‰∫ÜÂï¶");

                  // fool-proved
                  deleteDoubleCheck();

                  // ÊÉ≥Ë¶ÅÂú®Êåâ‰∏ãÊüêÂàódeleteÊôÇËÆÄÂà∞Ë©≤ÂàóÁöÑnoti_idÔºåÁÑ∂ÂæåÂÜçÂà™Èô§ÈÇ£Êï¥Á≠ÜË≥áÊñô
                  const notificationId = notification.Noti_id;
                  console.log(notificationId); //ÈÄôÂÄãÂèØ‰ª•ÔºåÊáâË©≤ÊòØ‰∏äÈù¢noti_idÊ≤íÊé•Âà∞
                  console.log("deleteÁöÑ" + notification); // ÊúâËÆÄÂà∞Áâ©‰ª∂

                  const notificationRef = ref(
                    db,
                    `notifications/${notificationId}`
                  );
                  remove(notificationRef) //Ê†πÊìöNoti_idÂà™ÊéâÊï¥Á≠ÜÁ¥ÄÈåÑ
                    .then(() => {
                      findNoti(); //ÈáçÊñ∞ËºâÂÖ•ÂàóË°®
                      console.log("Notification deleted successfully");
                    })
                    .catch((error) => {
                      console.error("Error deleting notification:", error);
                    });
                });

                editCell.appendChild(deleteButton);
                newRow.appendChild(pinCell);
                newRow.appendChild(notificationCell);
                newRow.appendChild(locationCell);
                newRow.appendChild(dateCell);
                newRow.appendChild(editCell);

                tableBody.appendChild(newRow);
              });
            } else {
              console.log("No notifications found.");
            }
          })
          .catch((error) => {
            console.error(error);
          });
        // console.log("Notification:", notification);
      }

      document.addEventListener("DOMContentLoaded", findNoti);

      //   // Reference to the notifications data in Firebase
      //   const notificationsRef = ref(db, "notifications/" + noti_id);

      //   // Listen for data changes
      //   onValue(notificationsRef, (snapshot) => {
      //     const data = snapshot.val();
      //     updateTable(data);
      //   });

      //   // Function to update HTML table
      //   function updateTable(data) {
      //     const tableBody = document.getElementById("tableBody");
      //     tableBody.innerHTML = ""; // Clear the existing table data

      //     for (const id in data) {
      //       const notification = data[id];
      //       const row = document.createElement("tr");

      //       const pinCell = document.createElement("td");
      //       pinCell.textContent = notification.Pin ? "v" : "";
      //       row.appendChild(pinCell);

      //       const announcementCell = document.createElement("td");
      //       announcementCell.textContent = notification.Context;
      //       row.appendChild(announcementCell);

      //       const locationCell = document.createElement("td");
      //       locationCell.textContent = notification.Venue;
      //       row.appendChild(locationCell);

      //       const dateCell = document.createElement("td");
      //       dateCell.textContent = notification.Date.split(" ")[0];
      //       row.appendChild(dateCell);

      //       const timeCell = document.createElement("td");
      //       timeCell.textContent = notification.Date.split(" ")[1];
      //       row.appendChild(timeCell);

      //       const editCell = document.createElement("td");
      //       const deleteButton = document.createElement("button");
      //       deleteButton.textContent = "DELETE";
      //       deleteButton.addEventListener("click", () => deleteNotification(id));
      //       editCell.appendChild(deleteButton);
      //       row.appendChild(editCell);

      //       tableBody.appendChild(row);
      //     }
      //   }
      //
    </script>
  </body>
  <style>
    html,
    body {
      margin: 0;
      padding: 0;
    }
    header {
      display: flex;
      align-content: flex-start;
      justify-content: space-between;
      background-color: lemonchiffon;
      padding: 4px 16px;
    }
    .user_icon {
      display: flex;
      align-items: center;
      padding: 0px 8px;
    }

    img {
      height: 30px;
      width: auto;
      margin: 8px;
      border-radius: 50%;
    }
    .main_sec {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .title {
      width: 90%;
      display: flex;
      justify-content: space-between;
      align-items: end;
    }
    h2,
    h3 {
      margin: 16px;
    }
    h3.add_btn,
    h3.host_btn {
      padding: 4px 8px;
      border-radius: 5px;
      background-color: lemonchiffon;
      box-shadow: 1px 3px 5px #ccc;
    }
    h3.add_btn,
    h3.host_btn:hover {
      cursor: pointer;
      box-shadow: 2px 5px 8px #aaa;
    }
    table {
      border-collapse: collapse; /* ÂêàÂπ∂ËæπÊ°Ü */
      width: 90%;
    }

    table,
    th,
    td {
      border: 1px solid #aaa;
      padding: 8px;
    }

    th {
      background-color: lemonchiffon;
    }
  </style>
</html>
